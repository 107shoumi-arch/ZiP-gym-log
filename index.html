<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ZiP TACTICAL LOG /// v19</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  /* === ESPORTS THEME V19 (Pixel Perfect Fix) === */
  :root {
    --bg: #121212;
    --card: #1e1e1e;
    --border: #333333;
    --text-main: #e0e0e0;
    --text-sub: #888888;
    --accent: #6b8e23; /* Military Green */
    --warn: #a63737;    /* Brick Red */
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Roboto Mono', monospace;
    margin: 0; padding: 1.2rem; 
    padding-bottom: 220px; 
    background-color: var(--bg); color: var(--text-main); 
    display: flex; justify-content: center;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
  }
  .shell { width: 100%; max-width: 600px; }

  h1 { 
    font-size: 1.5rem; text-align: center; margin: 10px 0 1.5rem; 
    letter-spacing: 2px; color: var(--text-sub); font-weight: 700;
    border-bottom: 2px solid var(--accent); display: block; width: 100%; padding-bottom: 10px;
    line-height: 1.3;
  }
  
  section {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    margin-bottom: 1.2rem; padding: 1.4rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  }
  
  /* ä¿®æ­£é» 1: å¢åŠ æ¨™é¡Œä¸‹æ–¹çš„è·é›¢ (åŸæœ¬æ˜¯15px -> æ”¹ç‚º 25px)ï¼Œè§£æ±ºé‡ç–Š */
  h2 { 
    font-size: 0.95rem; margin: 0 0 25px 0; display: flex; justify-content: space-between; align-items: center;
    color: var(--text-main); font-weight: 600; border-left: 4px solid var(--accent); padding-left: 12px; letter-spacing: 1px;
  }
  h2 small { font-size: 0.75rem; color: var(--text-sub); font-weight: 400; text-transform: uppercase; }

  label { display: block; font-size: 0.75rem; color: var(--text-sub); margin-bottom: 6px; font-family: 'Roboto Mono'; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  
  .sub-label { font-size: 0.8rem; color: var(--accent); margin-top: 20px; margin-bottom: 8px; display:block; font-weight:bold; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }

  /* ä¿®æ­£é» 2: å¼·åˆ¶çµ±ä¸€ Input é«˜åº¦èˆ‡æ¨£å¼ï¼Œè§£æ±ºæ—¥æœŸæ¡†éŒ¯ä½ */
  input, select, textarea {
    width: 100%; background: #181818; border: 1px solid #444; color: var(--text-main);
    padding: 0 12px; /* ä¸Šä¸‹ Padding æ”¹ç”¨ height æ§åˆ¶ */
    height: 45px;    /* å¼·åˆ¶é«˜åº¦ï¼Œç¢ºä¿ Date å’Œ Text ä¸€æ¨£é«˜ */
    line-height: 45px;
    font-size: 16px; margin-bottom: 6px; border-radius: 4px; transition: 0.2s; 
    font-family: 'Roboto Mono';
    appearance: none; -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­æ¨£å¼ */
  }
  /* æ—¥æœŸé¸å–®ç‰¹æ®Šè™•ç†ï¼Œç¢ºä¿æ–‡å­—å‚ç›´ç½®ä¸­ */
  input[type="date"], input[type="time"] { 
    display: flex; align-items: center; 
    padding-top: 2px; /* å¾®èª¿æ–‡å­—ä½ç½® */
  }

  input:focus, select:focus, textarea:focus { border-color: var(--accent); background: #222; }
  textarea { height: auto; min-height: 80px; padding: 12px; line-height: 1.5; }

  /* æ’ç‰ˆ Grid */
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
  
  .time-field { display: flex; gap: 8px; }
  
  .item-row, .food-row { background: #252525; padding: 12px; margin-bottom: 12px; border-radius: 6px; border-left: 3px solid var(--border); position: relative; }
  .item-controls { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px; }
  .food-inputs { display: grid; grid-template-columns: 1fr 60px 70px; gap: 8px; margin-top: 8px; }
  .item-controls input, .food-inputs input { text-align: center; padding: 0; height: 40px; line-height: 40px; font-size: 0.9rem; }
  .custom-input { display: none; border-color: var(--accent); margin-top:8px; }
  .custom-input.show { display: block; }

  button { background: #333; color: #ddd; border: none; padding: 0; height: 45px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; width: 100%; letter-spacing: 1px; display: flex; align-items: center; justify-content: center; }
  button:active { transform: scale(0.98); background: #444; }
  button.ghost { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
  button.ghost:active { background: var(--accent); color: #000; }
  button.add-btn { margin-top: 8px; background: rgba(255,255,255,0.05); border: 1px dashed #555; color: #888; }
  button.sm { width: auto; padding: 0 15px; height: 45px; font-size: 0.8rem; min-width: 60px; }
  .del-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: #333; color: #aaa; padding: 0; border-radius: 4px; font-size: 1rem; }

  /* åº•éƒ¨å·¥å…·åˆ— */
  .float-action { 
    position: fixed; bottom: 0; left: 0; width: 100%; 
    background: rgba(25, 25, 25, 0.95); backdrop-filter: blur(20px); 
    padding: 15px 20px; border-top: 1px solid #444; 
    display: grid; grid-template-columns: 60px 1fr 1fr; gap: 12px; z-index: 90; 
    box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
  }
  .float-action button.icon-only { background: #333; color: var(--text-sub); font-size: 1.4rem; height: 50px; }
  .float-action button.main { background: var(--accent); color: #000; font-weight: 700; height: 50px; }
  .float-action button.ghost { height: 50px; }

  /* === TIMER UI (æ‡¸æµ®æ–¹å¡Šé‚„åŸ) === */
  #timerBtn { 
    position: fixed; bottom: 110px; right: 20px; z-index: 99; width: 65px; height: 65px; 
    background: #000; border: 2px solid var(--accent); color: var(--accent); 
    display: flex; align-items: center; justify-content: center; 
    font-size: 24px; font-weight: bold; font-family: 'Roboto Mono'; border-radius: 50%; 
    box-shadow: 0 0 15px rgba(0,255,195,0.3); clip-path: polygon(30% 0, 70% 0, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0 70%, 0 30%);
  }
  
  #timerPanel { 
    position: fixed; bottom: 110px; right: 20px; width: 280px; 
    background: rgba(10, 10, 10, 0.98); border: 1px solid var(--accent); 
    padding: 15px; z-index: 100; display: none; 
    clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
  }
  #timerPanel.show { display: block; }
  
  .timer-header { display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.75rem; color:var(--accent); letter-spacing:1px; }
  #tVal { font-size: 2.8rem; font-family: 'Roboto Mono'; text-align: center; color: #fff; margin: 10px 0; text-shadow: 0 0 15px var(--accent); }
  .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .timer-controls button { height: 45px; } /* è¨ˆæ™‚å™¨æŒ‰éˆ•é«˜åº¦ */
  
  .laps-container { 
    max-height: 150px; overflow-y: auto; margin-top: 15px; 
    border-top: 1px dashed #333; padding-top: 5px; 
  }
  .lap-row { display: flex; justify-content: space-between; color: #888; font-size: 0.85rem; padding: 4px 0; border-bottom: 1px solid #222; font-family: 'Roboto Mono'; }

  /* æç¤ºæ¡† */
  #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--accent); color: #000; padding: 15px 30px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.2s; z-index: 1000; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); box-shadow: 0 0 20px rgba(0,255,195,0.4); }
  #toast.show { opacity: 1; }
  #copyArea { position: fixed; top: -9999px; opacity: 0; }
</style>
</head>
<body>

<div id="toast">âœ… å·²å­˜æª”</div>

<div id="timerBtn" onclick="toggleTimer()">00</div>

<div id="timerPanel">
  <div class="timer-header">
    <span>ç¢¼è¡¨ (STOPWATCH)</span> <span onclick="toggleTimer()" style="cursor:pointer">[âœ•]</span>
  </div>
  <div id="tVal">00:00.00</div>
  
  <div class="timer-controls">
    <button class="warn" id="tAction" onclick="timerAct()">é–‹å§‹</button>
    <button class="ghost" onclick="timerLapReset()" id="tLapReset">è¨ˆåœˆ</button>
  </div>

  <div class="laps-container" id="lapsList"></div>
</div>

<div class="shell">
  <h1>ZiP TACTICAL LOG /// v19</h1>

  <section>
    <h2>æ—¥æœŸèˆ‡æ™‚æ®µ <small>DATE & RANGE</small></h2>
    <div class="row">
        <div><label>æ—¥æœŸ (Date)</label><input type="date" id="dateVal"></div>
        <div><label>ç¸½å€é–“ (Auto Range)</label><input type="text" id="timeRange" placeholder="ä¾‹ 19:00 - 21:00"></div>
    </div>
  </section>

  <section>
    <h2>é‡è¨“ <small>RESISTANCE</small></h2>
    <div class="row">
      <div><label>é‡è¨“é–‹å§‹</label><div class="time-field"><input type="time" id="wtStart" oninput="autoTimeRange()"><button class="ghost sm" onclick="setNow('wtStart')">ç¾åœ¨</button></div></div>
      <div><label>é‡è¨“çµæŸ</label><div class="time-field"><input type="time" id="wtEnd" oninput="autoTimeRange()"><button class="ghost sm" onclick="setNow('wtEnd')">ç¾åœ¨</button></div></div>
    </div>
    <div style="text-align:right; color:var(--text-sub); font-size:0.8rem; margin-bottom:15px;" id="wtDur">æŒçºŒæ™‚é–“: 0 åˆ†é˜</div>
    
    <div id="exerciseList"></div>
    <button class="add-btn" onclick="addExercise()">[+] æ–°å¢å‹•ä½œ</button>
  </section>

  <section>
    <h2>æœ‰æ°§ <small>CARDIO</small></h2>
    <div class="row" style="margin-bottom:15px; border-bottom:1px dashed #333; padding-bottom:15px;">
       <div><label>æœ‰æ°§é–‹å§‹</label><div class="time-field"><input type="time" id="caStart" oninput="autoTimeRange()"><button class="ghost sm" onclick="setNow('caStart')">ç¾åœ¨</button></div></div>
       <div><label>æœ‰æ°§çµæŸ</label><div class="time-field"><input type="time" id="caEnd" oninput="autoTimeRange()"><button class="ghost sm" onclick="setNow('caEnd')">ç¾åœ¨</button></div></div>
    </div>
    <div id="cardioList"></div>
    <button class="add-btn" onclick="addCardio()">[+] æ–°å¢æœ‰æ°§</button>
    <div style="margin-top:15px;"><label>ä¼¸å±•æ™‚é–“ (åˆ†é˜)</label><input type="number" id="stretch" placeholder="ä¾‹å¦‚: 15"></div>
  </section>

  <section>
    <h2>é£²é£Ÿç´€éŒ„ <small>NUTRITION</small></h2>
    
    <label class="sub-label">æ—©é¤</label>
    <div id="listBreakfast"></div><button class="add-btn sm" onclick="addFood('listBreakfast', 'breakfast-options')">[+] æ–°å¢</button>

    <label class="sub-label">åˆé¤</label>
    <div id="listLunch"></div><button class="add-btn sm" onclick="addFood('listLunch', 'lunch-options')">[+] æ–°å¢</button>

    <label class="sub-label">ä¸‹åˆèŒ¶</label>
    <div id="listSnack"></div><button class="add-btn sm" onclick="addFood('listSnack', 'snack-options')">[+] æ–°å¢</button>

    <label class="sub-label">é‹å‹•å‰è£œçµ¦</label>
    <div id="listPre"></div><button class="add-btn sm" onclick="addFood('listPre', 'pre-options')">[+] æ–°å¢</button>

    <label class="sub-label">æ™šé¤ / é‹å‹•å¾Œ</label>
    <div id="listPost"></div><button class="add-btn sm" onclick="addFood('listPost', 'post-options')">[+] æ–°å¢</button>

    <div style="margin-top:25px; padding-top:15px; border-top:1px solid #333;">
        <label class="sub-label" style="border:none; color:var(--text-main);">é£²æ°´ç¸½é‡ (ML)</label>
        <div class="row">
            <input type="number" id="wWork" placeholder="é‹å‹•é£²æ°´" oninput="calcWater()">
            <input type="number" id="wDay" placeholder="æ—¥å¸¸é£²æ°´" oninput="calcWater()">
        </div>
        <div style="text-align:right; color:var(--accent); font-size:0.95rem; font-weight:bold;" id="wTotal">ç¸½è¨ˆ: 0 ML</div>
    </div>
  </section>

  <section>
    <h2>å‚™è¨» <small>NOTES</small></h2>
    <textarea id="note" placeholder="ç´€éŒ„ä»Šæ—¥èº«é«”ç‹€æ³..."></textarea>
  </section>
</div>

<div class="float-action">
  <button class="icon-only" onclick="forceReset()">ğŸ—‘ï¸</button>
  <button class="ghost" onclick="genText()">ğŸ“‹ è¤‡è£½æ—¥èªŒ</button>
  <button class="main" onclick="manualSave()">ğŸ’¾ æ‰‹å‹•å­˜æª”</button>
</div>
<textarea id="copyArea"></textarea>

<template id="equipment-options">
    <option value="">â€” é¸æ“‡å™¨æ â€”</option>
    <optgroup label="èƒŒéƒ¨èˆ‡ä¸ŠåŠèº«">
      <option>åˆ†é›¢å¼åå§¿åˆ’èˆ¹æ©Ÿ</option><option>åå§¿åˆ’èˆ¹æ©Ÿ</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆå¯¬è·ï¼‰</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆçª„è·ï¼‰</option>
      <option>é«˜ä½ä¸‹æ‹‰ï¼ˆçª„è·åæ¡ï¼‰</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆWæŠŠæ‰‹ï¼‰</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆVæŠŠæ‰‹ï¼‰</option>
      <option>è´è¶æ©Ÿï¼ˆæ­£é¢èƒ¸æ¨ï¼‰</option><option>è´è¶æ©Ÿï¼ˆåé¢èƒŒé£›ï¼‰</option>
    </optgroup>
    <optgroup label="ä¸‹åŠèº«">
      <option>è…¿éƒ¨æ¨è¹¬æ©Ÿ</option><option>åå§¿å‹¾è…¿æ©Ÿ</option><option>ä¿¯è‡¥å‹¾è…¿æ©Ÿ</option>
      <option>å¤¾è…¿æ©Ÿ</option><option>é–‹è…¿æ©Ÿ</option><option>ä¸‹èƒŒè¨“ç·´æ©Ÿ</option>
    </optgroup>
    <optgroup label="æ ¸å¿ƒ"><option>å·è…¹æ©Ÿ</option></optgroup>
    <option value="__custom__">è‡ªè¨‚...</option>
</template>
<template id="cardio-options"><option value="">â€” é¸æ“‡é …ç›® â€”</option><option>æ»‘æ­¥æ©Ÿ</option><option>éšæ¢¯æ©Ÿ</option><option>è¸æ­¥æ©Ÿ</option><option>èººå¼è…³è¸è»Š</option><option>ç›´ç«‹è…³è¸è»Š</option><option>è·‘æ­¥æ©Ÿ</option><option value="__custom__">è‡ªè¨‚...</option></template>
<template id="breakfast-options"><option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option><option>ç¾å¼å’–å•¡</option><option>è¥¿è¥¿é‡Œå’–å•¡</option><option>ç„¡ç³–ç¶ èŒ¶</option><option>æ°£æ³¡æ°´</option><option>çƒ¤åœŸå¸</option><option>å…¨å®¶ è‘¡è„åå¸2ç‰‡</option><option>è·åŒ…è›‹</option><option>æ»·è›‹</option><option>æ—é³³ç‡Ÿå¸Œè‡˜å¼å„ªæ ¼(åŸå‘³ç„¡ç³–)</option><option>çƒ¤åœ°ç“œ(å†°)</option><option>çƒ¤åœ°ç“œ(ç†±)</option><option>è˜¿è””ç³•</option><option>å‰ç‡’åŒ…</option><option>è‚‰æ¡‚æ²</option><option value="__custom__">è‡ªè¨‚...</option></template>
<template id="lunch-options"><option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option><option>èƒ½é‡å°å§-æ°´ç…®å«©é›èƒ¸</option><option>èƒ½é‡å°å§-é¦™æ»·é›è…¿</option><option>èƒ½é‡å°å§-æ—¥å¼å£½å–œç‰›ä¾¿ç•¶</option><option>èƒ½é‡å°å§-ç…§ç‡’é›è…¿æ’</option><option>ç«¹æ—ä¾¿ç•¶-é¦™é…¥å¤§é›æ’é£¯</option><option>ç«¹æ—ä¾¿ç•¶-åšåˆ‡è±¬æ’é£¯</option><option>å¤©å¤©çƒ¤è‚‰-æ‹›ç‰Œçƒ¤è‚‰é£¯</option><option>ç‰›æ’</option><option>èŠ±æ¤°èœ</option><option>å››å­£è±†</option><option>é«˜éº—èœ</option><option>é¦¬éˆ´è–¯</option><option>ç™½é£¯</option><option>ç³™ç±³é£¯</option><option>é†‹é£¯</option><option>ç‚’é£¯</option><option>æ„›é¢ç…®ï¼ˆç´…ç‡’ç‰›è‚‰é¢¨å‘³ï¼‰</option><option>æ°£ç‚¸é›èƒ¸è‚‰</option><option>é†¬ç‡’é›èƒ¸è‚‰</option><option>ä¸‰æ¯é›</option><option>æ——é­šç”Ÿé­šç‰‡</option><option>é®ªé­šç”Ÿé­šç‰‡</option><option>é®­é­šç”Ÿé­šç‰‡</option><option>é¯¡é­šåµç”Ÿé­šç‰‡</option><option value="__custom__">è‡ªè¨‚...</option></template>
<template id="snack-options"><option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option><option>ç¾å¼å’–å•¡</option><option>ç„¡ç³–ç¶ èŒ¶</option><option>æ°£æ³¡æ°´</option><option>ç¦æ¨‚ è¶…èƒ½è›‹ç™½ç‡Ÿé¤Šç‰›ä¹³å¯å¯å£å‘³ (375 mL)</option><option>æ°´æœï¼ˆèŠ­æ¨‚ï¼‰</option><option>é¤…ä¹¾ï¼å°é»å¿ƒ</option><option>åŸå‘³å„ªæ ¼</option><option>æ—é³³ç‡Ÿ å¸Œè‡˜å¼å„ªæ ¼(åŸå‘³ç„¡ç³–)</option><option>èŠ­æ¨‚</option><option>è˜‹æœ</option><option>èŠ’æœ</option><option>æ°´æ¢¨</option><option>æŸ³ä¸</option><option>æ©˜å­</option><option>å»æ®¼æ¤°å­</option><option>è—è“</option><option>ä¹³æ¸…è›‹ç™½ 40g</option><option>ä¹³æ¸…è›‹ç™½ 30g</option><option value="__custom__">è‡ªè¨‚...</option></template>
<template id="pre-options"><option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option><option>ç¾å¼å’–å•¡</option><option>è¥¿è¥¿é‡Œå’–å•¡</option><option>æ‰‹æ²–å’–å•¡</option><option>ç„¡ç³–ç¶ èŒ¶</option><option>æ°£æ³¡æ°´</option><option>å…‰æ³‰ å„ªè³ªè›‹ç™½ç‰›ä¹³ å·§å…‹åŠ›å£å‘³ (400ml)</option><option>ç¦æ¨‚ è¶…èƒ½è›‹ç™½ç‡Ÿé¤Šç‰›ä¹³ å¯å¯å£å‘³ (375 mL)</option><option>ç¦æ¨‚ è¶…èƒ½è›‹ç™½ç‡Ÿé¤Šç‰›ä¹³ å’–å•¡å£å‘³ (375 mL)</option><option>çƒ¤åœ°ç“œ (å†°)</option><option>çƒ¤åœ°ç“œ (ç†±)</option><option>å…¨å®¶ è‘¡è„åå¸2ç‰‡</option><option>å…¨å®¶ å¤§äº¨å ¡ (åŸå‘³ç†±ç‹—+ç•ªèŒ„é†¬é…¸é»ƒç“œé†¬)</option><option>é¦™è•‰</option><option>èŠ­æ¨‚</option><option>è˜‹æœ</option><option>èŠ’æœ</option><option>æ°´æ¢¨</option><option>æŸ³ä¸</option><option>æ©˜å­</option><option>å»æ®¼æ¤°å­</option><option>è—è“</option><option>ä¹³æ¸…è›‹ç™½ 40g</option><option>ä¹³æ¸…è›‹ç™½ 30g</option><option value="__custom__">è‡ªè¨‚...</option></template>
<template id="post-options"><option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option><option>ç‰›é›œæ¹¯ï¼ˆåªåƒæ–™ï¼‰</option><option>ç‰›æ’</option><option>èŠ±æ¤°èœ</option><option>å››å­£è±†</option><option>é«˜éº—èœ</option><option>é¦¬éˆ´è–¯</option><option>ç™½é£¯</option><option>ç³™ç±³é£¯</option><option>é†‹é£¯</option><option>æ°£ç‚¸é›èƒ¸è‚‰</option><option>æ——é­šç”Ÿé­šç‰‡</option><option>é®ªé­šç”Ÿé­šç‰‡</option><option>é®­é­šç”Ÿé­šç‰‡</option><option>é¯¡é­šåµç”Ÿé­šç‰‡</option><option>æ„›ä¹‹å‘³é®ªé­šç½é ­ï¼ˆæ°´ç…®ï¼‰185g</option><option>è·åŒ…è›‹</option><option>æ»·è›‹</option><option>æºå¿ƒè›‹</option><option>è±†è–¯æ¶¼æ‹Œ</option><option>åŸå‘³å„ªæ ¼</option><option>èŠ­æ¨‚</option><option>è˜‹æœ</option><option>èŠ’æœ</option><option>æ°´æ¢¨</option><option>æŸ³ä¸</option><option>æ©˜å­</option><option>å»æ®¼æ¤°å­</option><option>è—è“</option><option>ä¹³æ¸…è›‹ç™½ 40g</option><option>ä¹³æ¸…è›‹ç™½ 30g</option><option value="__custom__">è‡ªè¨‚...</option></template>

<script>
const KEY = 'ZIP_LOG_V19_DATA';
let tInt=null, totalStartTime=0, lapStartTime=0, tTotalElapsed=0, laps=[];

// === å–®ä½åˆ¤æ–· ===
function checkUnit(v, u) {
  const m = { 'ml':['å’–','èŒ¶','é£²','æ°´','æ¹¯','å¥¶','é…’','æ¨‚','ä¹³'], 'é¡†':['è›‹','æœ','æ©˜','æŸ³','å¥‡','é¤ƒ','éŒ ','æ¤°'], 'g':['é›','ç‰›','è±¬','é­š','è‚‰','é£¯','ç“œ','è–¯','èœ','æ ¼','è›‹ç™½'], 'ç‰‡':['å','é¤…','èµ·','ç³•','æ’'], 'ä»½':['ä¾¿','é¤','å ¡','æ²»','éºµ'] };
  for(const [k, arr] of Object.entries(m)) if(arr.some(x => v.includes(x))) { u.value = k; break; }
}

// === DOM ===
const val=s=>document.querySelector(s)?.value||''; 
const set=(s,v)=>{const e=document.querySelector(s);if(e)e.value=v||''}; 
const getAll=s=>[...document.querySelectorAll(s)]; 
const pad=n=>String(n).padStart(2,'0');

function createRow(tid, ph, vals={}) {
  const div = document.createElement('div');
  div.className = tid.includes('option') && !tid.includes('equip') && !tid.includes('cardio') ? 'food-row' : 'item-row';
  const sel = document.createElement('select'); sel.innerHTML = document.getElementById(tid).innerHTML;
  const cust = document.createElement('input'); cust.type = 'text'; cust.className = 'custom-input'; cust.placeholder = ph;
  const del = document.createElement('button'); del.innerHTML = '&times;'; del.className = 'del-btn'; del.onclick = () => div.remove();
  const chk = (v) => { if(div.querySelector('.unit')) checkUnit(v, div.querySelector('.unit')); };
  sel.onchange = () => { if(sel.value==='__custom__'){cust.classList.add('show');cust.focus();}else{cust.classList.remove('show');chk(sel.value);} };
  cust.oninput = () => chk(cust.value);
  if (vals.n) { if([...sel.options].some(o=>o.value===vals.n)) sel.value = vals.n; else { sel.value='__custom__'; cust.classList.add('show'); cust.value=vals.n; } }
  div.append(del, sel, cust); return { div, sel, cust };
}

function addExercise(d={}) {
  const {div} = createRow('equipment-options', 'å™¨æåç¨±', d);
  const c = document.createElement('div'); c.className='item-controls';
  c.innerHTML = `<input type="number" class="s" placeholder="çµ„æ•¸" value="${d.s||''}"><input type="number" class="r" placeholder="æ¬¡æ•¸" value="${d.r||''}"><input type="number" class="w" placeholder="é‡é‡kg" value="${d.w||''}"><input type="number" class="rt" placeholder="ä¼‘æ¯ç§’" value="${d.rt||''}">`;
  div.appendChild(c); document.getElementById('exerciseList').appendChild(div);
}
function addCardio(d={}) {
  const {div} = createRow('cardio-options', 'æœ‰æ°§é …ç›®', d);
  const c = document.createElement('div'); c.className='item-controls'; c.style.gridTemplateColumns="1fr 1fr 1fr";
  c.innerHTML = `<input type="number" class="dur" placeholder="åˆ†é˜" value="${d.dur||''}"><input type="number" class="lv" placeholder="ç­‰ç´š" value="${d.lv||''}"><input type="number" class="bpm" placeholder="å¿ƒç‡" value="${d.bpm||''}">`;
  div.appendChild(c); document.getElementById('cardioList').appendChild(div);
}
function addFood(lid, tid, d={}) {
  const {div} = createRow(tid, 'é£Ÿç‰©åç¨±', d);
  const c = document.createElement('div'); c.className='food-inputs';
  c.innerHTML = `<input type="number" class="amt" placeholder="æ•¸é‡" value="${d.a||''}"><select class="unit"><option value="g">g</option><option value="ml">ml</option><option value="ä»½">ä»½</option><option value="é¡†">é¡†</option><option value="ç‰‡">ç‰‡</option></select>`;
  if(d.u) c.querySelector('.unit').value = d.u;
  div.appendChild(c); document.getElementById(lid).appendChild(div);
}

function getName(r) { const s=r.querySelector('select'), c=r.querySelector('.custom-input'); return s.value==='__custom__'?c.value:s.value; }
function v(p,s) { return p.querySelector(s)?.value||''; }

// === IO ===
function save(silent=true) {
  const d = {
    dateVal: val('#dateVal'), timeRange: val('#timeRange'), 
    wtStart:val('#wtStart'), wtEnd:val('#wtEnd'), caStart:val('#caStart'), caEnd:val('#caEnd'), stretch:val('#stretch'), wWork:val('#wWork'), wDay:val('#wDay'), note:val('#note'),
    exs: getAll('#exerciseList .item-row').map(r=>({ n:getName(r), s:v(r,'.s'), r:v(r,'.r'), w:v(r,'.w'), rt:v(r,'.rt') })),
    cardios: getAll('#cardioList .item-row').map(r=>({ n:getName(r), dur:v(r,'.dur'), lv:v(r,'.lv'), bpm:v(r,'.bpm') })),
    foods: { bf:getF('listBreakfast'), lu:getF('listLunch'), sn:getF('listSnack'), pre:getF('listPre'), post:getF('listPost') },
    timer: { totalStart: totalStartTime, lapStart: lapStartTime, totalElapsed: tTotalElapsed, running: !!tInt, laps: laps }
  };
  localStorage.setItem(KEY, JSON.stringify(d));
  if(!silent){ const t=document.getElementById('toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1000); }
}
function getF(id) { return getAll(`#${id} .food-row`).map(r=>({ n:getName(r), a:v(r,'.amt'), u:v(r,'.unit') })); }

function load() {
  const raw = localStorage.getItem(KEY);
  if(!raw){ document.getElementById('dateVal').valueAsDate = new Date(); addExercise(); return; }
  const d = JSON.parse(raw);
  
  if(d.dateVal) set('#dateVal', d.dateVal); else document.getElementById('dateVal').valueAsDate = new Date();
  set('#timeRange', d.timeRange);

  set('#wtStart',d.wtStart); set('#wtEnd',d.wtEnd); set('#caStart',d.caStart); set('#caEnd',d.caEnd); 
  set('#stretch',d.stretch); set('#wWork',d.wWork); set('#wDay',d.wDay); set('#note',d.note);
  
  document.getElementById('exerciseList').innerHTML=''; if(d.exs) d.exs.forEach(x=>addExercise(x));
  document.getElementById('cardioList').innerHTML=''; if(d.cardios) d.cardios.forEach(x=>addCardio(x));
  
  const rf = (lid,tid,lst) => { document.getElementById(lid).innerHTML=''; if(lst) lst.forEach(x=>addFood(lid,tid,x)); };
  if(d.foods) { rf('listBreakfast','breakfast-options',d.foods.bf); rf('listLunch','lunch-options',d.foods.lu); rf('listSnack','snack-options',d.foods.sn); rf('listPre','pre-options',d.foods.pre); rf('listPost','post-options',d.foods.post); }
  
  if(d.timer) { 
    tTotalElapsed = d.timer.totalElapsed || 0;
    laps = d.timer.laps || [];
    renderLaps();
    if(d.timer.running) { totalStartTime = d.timer.totalStart; lapStartTime = d.timer.lapStart; startT(); } 
    else { updT(0, tTotalElapsed); }
  }
  calcTime(); calcWater();
}

// === æ™ºæ…§è‡ªå‹•æŠ“é ­å°¾ (Auto Range) ===
function autoTimeRange() {
    const times = [ val('#wtStart'), val('#wtEnd'), val('#caStart'), val('#caEnd') ].filter(t => t !== ""); 
    if (times.length >= 2) { times.sort(); set('#timeRange', `${times[0]} - ${times[times.length - 1]}`); }
}

// === Timer ===
function fmtT(ms, showMs=true) { 
    const m = Math.floor(ms/60000); const s = Math.floor((ms%60000)/1000);
    if(!showMs) return `${pad(m)}:${pad(s)}`;
    const cs = Math.floor((ms%1000)/10);
    return `${pad(m)}:${pad(s)}.${pad(cs)}`;
}
function updT(lapMs, totalMs) {
  document.getElementById('tVal').innerText = fmtT(lapMs, false); 
  document.getElementById('timerBtn').innerText = String(Math.floor((lapMs%60000)/1000)).padStart(2,'0');
}
function startT() {
  const btn = document.getElementById('tAction'); btn.innerText = "æš«åœ"; btn.className = "warn"; document.getElementById('tLapReset').innerText = "è¨ˆåœˆ"; 
  tInt = setInterval(() => { const now = Date.now(); updT(now - lapStartTime, tTotalElapsed + (now - totalStartTime)); }, 50);
}
function timerAct() {
  if(tInt) { clearInterval(tInt); tInt = null; tTotalElapsed += Date.now() - totalStartTime; document.getElementById('tAction').innerText = "ç¹¼çºŒ"; document.getElementById('tAction').className = "ghost"; document.getElementById('tLapReset').innerText = "é‡ç½®"; save(true); }
  else { if(totalStartTime === 0 || document.getElementById('tAction').innerText === "é–‹å§‹") { totalStartTime = Date.now(); lapStartTime = Date.now(); tTotalElapsed = 0; laps = []; renderLaps(); } else { totalStartTime = Date.now(); lapStartTime = Date.now() - (parseMs(document.getElementById('tVal').innerText)); } startT(); }
}
function parseMs(str) { let parts = str.split(':'); return (parseInt(parts[0])*60000) + (parseInt(parts[1])*1000); }
function timerLapReset() {
  if(tInt) { laps.unshift(Date.now() - lapStartTime); renderLaps(); lapStartTime = Date.now(); } 
  else { tTotalElapsed = 0; totalStartTime = 0; lapStartTime = 0; laps = []; updT(0, 0); document.getElementById('lapsList').innerHTML=''; document.getElementById('tAction').innerText="é–‹å§‹"; document.getElementById('tAction').className="warn"; document.getElementById('tLapReset').innerText="è¨ˆåœˆ"; save(true); }
}
function renderLaps() { document.getElementById('lapsList').innerHTML = laps.map((t,i) => `<li class="lap-row"><span>åœˆ ${laps.length-i}</span><span>${fmtT(t)}</span></li>`).join(''); }
function toggleTimer() { document.getElementById('timerPanel').classList.toggle('show'); }

// === Reset & Copy ===
function forceReset() {
  if(confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºä¸¦é–‹å§‹æ–°çš„ä¸€å¤©å—ï¼Ÿ')) {
    localStorage.removeItem(KEY);
    location.reload();
  }
}
async function genText() {
  save(true); const d=JSON.parse(localStorage.getItem(KEY)); 
  const dateStr = d.dateVal ? d.dateVal.replace(/-/g, '/') : new Date().toLocaleDateString();
  let t=`ğŸ“… ${dateStr} è¨“ç·´æ—¥èªŒ\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
  const timeShow = d.timeRange ? d.timeRange : (d.wtStart ? `${d.wtStart} - ${d.wtEnd}` : '');
  if(timeShow) t += `â° æ™‚é–“: ${timeShow}\n`;
  if(d.exs.some(x=>x.n)) { t+=`\nğŸ‹ï¸ é‡è¨“é …ç›®\n`; d.exs.forEach(x=>{if(x.n)t+=`â€¢ ${x.n}ï½œ${x.s}çµ„Ã—${x.r}æ¬¡ï½œ${x.w}kg${x.rt?` (ä¼‘${x.rt}s)`:''}\n`}); }
  if(d.cardios.some(x=>x.n)||val('#caStart')) { t+=`\nğŸƒ æœ‰æ°§èˆ‡ä¼¸å±•\n`; d.cardios.forEach(x=>{if(x.n)t+=`â€¢ ${x.n}ï½œ${x.dur}åˆ† (Lv.${x.lv}/${x.bpm}bpm)\n`}); if(val('#stretch'))t+=`â€¢ ä¼¸å±•: ${val('#stretch')} åˆ†é˜\n`; }
  t+=`\nğŸ¥— é£²é£Ÿç´€éŒ„\n`;
  const ft=(l,h)=>{ if(l.some(x=>x.n)){ t+=`[${h}] `; t+=l.filter(x=>x.n).map(x=>`${x.n} ${x.a}${x.u}`).join('ã€')+'\n'; } };
  ft(d.foods.bf,'æ—©é¤'); ft(d.foods.lu,'åˆé¤'); ft(d.foods.sn,'åˆèŒ¶'); ft(d.foods.pre,'é‹å‰'); ft(d.foods.post,'é‹å¾Œ');
  t+=`\nğŸ’§ é£²æ°´ç¸½è¨ˆ: ${document.getElementById('wTotal').innerText.replace('ç¸½è¨ˆ: ','')}`;
  if(d.note) t+=`\n\nğŸ“ å‚™è¨»\n${d.note}`;
  try { await navigator.clipboard.writeText(t); alert('æ—¥èªŒå·²è¤‡è£½ï¼'); }
  catch(e) { const a=document.getElementById('copyArea'); a.value=t; a.select(); document.execCommand('copy'); alert('æ—¥èªŒå·²è¤‡è£½ (å…¼å®¹æ¨¡å¼)'); }
}

function manualSave() { save(false); }
setInterval(()=>save(true), 900000);
window.addEventListener('visibilitychange', ()=>{if(document.hidden)save(true)});
function setNow(id) { const n=new Date(); document.getElementById(id).value=`${pad(n.getHours())}:${pad(n.getMinutes())}`; calcTime(); autoTimeRange(); } 
function calcTime() { const d=(s,e)=>{if(!s||!e)return 0; const [h1,m1]=s.split(':').map(Number); const [h2,m2]=e.split(':').map(Number); return Math.max(0,(h2*60+m2)-(h1*60+m1));}; document.getElementById('wtDur').innerText=`æŒçºŒ: ${d(val('#wtStart'),val('#wtEnd'))} åˆ†é˜`; }
function calcWater() { document.getElementById('wTotal').innerText=`ç¸½è¨ˆ: ${(Number(val('#wWork'))||0)+(Number(val('#wDay'))||0)} ML`; }
load();
</script>
</body>
</html>
