<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ZIP LOG /// SYSTEM V12</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  /* === ESPORTS THEME V12 === */
  :root { --bg: #050505; --border: #333; --accent: #00ffc3; --sec: #00a8ff; --warn: #ff0055; --text: #eee; --muted: #666; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  body {
    font-family: 'SF Pro Text', 'Roboto Mono', sans-serif; margin: 0; padding: 1.2rem; padding-bottom: 180px;
    background-color: var(--bg); color: var(--text); display: flex; justify-content: center;
    background-image: linear-gradient(rgba(0, 255, 195, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 195, 0.03) 1px, transparent 1px); background-size: 20px 20px;
  }
  .shell { width: 100%; max-width: 600px; }

  h1 { font-size: 1.8rem; text-align: center; margin: 0 0 1.5rem; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0,255,195,0.3); border-bottom: 2px solid var(--accent); padding-bottom: 5px; display: inline-block; width: 100%; }
  section { background: rgba(17, 17, 17, 0.8); border: 1px solid var(--border); margin-bottom: 1.2rem; padding: 1.2rem; clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%); }
  
  h2 { font-size: 1rem; margin: 0; display: flex; justify-content: space-between; color: var(--accent); border-left: 4px solid var(--accent); padding-left: 10px; }
  h2 small { font-size: .6rem; color: var(--muted); }
  .sub-label { font-size: 0.85rem; color: var(--sec); margin-top: 15px; margin-bottom: 8px; display:block; font-weight:bold; border-bottom: 1px dashed #333; }
  
  input, select, textarea { width: 100%; background: #000; border: 1px solid var(--border); color: var(--accent); padding: 10px; font-size: 16px; margin-bottom: 5px; font-family: 'Roboto Mono', monospace; transition: 0.2s; }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(0,255,195,0.2); }
  
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
  .time-field { display: flex; gap: 5px; }
  .item-row, .food-row { background: #0a0a0a; padding: 10px; margin-bottom: 10px; border: 1px solid #222; border-left: 3px solid var(--sec); position: relative; }
  .food-row { border-left: none; border-right: 3px solid var(--warn); }
  .item-controls, .food-inputs { display: grid; gap: 5px; margin-top: 5px; }
  .item-controls { grid-template-columns: repeat(4, 1fr); }
  .food-inputs { grid-template-columns: 1fr 60px 70px; }
  
  .custom-input { display: none; border-color: var(--sec); color: var(--sec); margin-top:5px; }
  .custom-input.show { display: block; }
  
  button { background: var(--border); color: var(--text); border: none; padding: 10px; font-weight: 700; cursor: pointer; width: 100%; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px); }
  button:active { transform: translateY(2px); }
  button.ghost { background: rgba(0,255,195,0.1); color: var(--accent); border: 1px solid rgba(0,255,195,0.3); }
  button.warn { background: rgba(255,0,85,0.15); color: var(--warn); border: 1px solid var(--warn); }
  button.sm { width: auto; padding: 4px 10px; font-size: 0.75rem; min-width: 40px; }
  button.add-btn { margin-top: 5px; background: transparent; border: 1px dashed #444; color: #666; clip-path: none; }
  .del-btn { position: absolute; top: 5px; right: 5px; width: 25px; height: 25px; background: transparent; color: #444; padding: 0; clip-path: none; }

  /* === åº•éƒ¨å·¥å…·åˆ— (æ•´åˆé‡ç½®æŒ‰éˆ•) === */
  .float-action { 
    position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(10px); 
    padding: 15px; border-top: 1px solid var(--accent); 
    display: grid; grid-template-columns: 60px 1fr 1fr; gap: 10px; z-index: 90; 
  }
  .float-action button { padding: 15px 0; font-size: 0.9rem; }
  .float-action button.icon-only { font-size: 1.5rem; padding: 0; display:flex; align-items:center; justify-content:center; background: #220000; color: var(--warn); border: 1px solid var(--warn); }
  .float-action button.main { background: var(--accent); color: #000; }

  /* === å·¨å‹è¨ˆæ™‚å™¨ (BIG TIMER) === */
  #timerBtn { 
    position: fixed; bottom: 100px; right: 20px; z-index: 99; width: 70px; height: 70px; 
    background: #000; border: 2px solid var(--accent); color: var(--accent); 
    display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold;
    clip-path: polygon(30% 0, 70% 0, 100% 30%, 100% 70%, 70% 100%, 30% 100%, 0 70%, 0 30%); 
    box-shadow: 0 0 20px rgba(0,255,195,0.3); transition: transform 0.2s;
  }
  #timerBtn:active { transform: scale(0.9); }

  /* å…¨è¢å¹•é®ç½©æ¨¡å¼ */
  #timerPanel { 
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.92); backdrop-filter: blur(15px);
    z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center;
    padding: 20px; opacity: 0; transition: opacity 0.3s;
  }
  #timerPanel.show { display: flex; opacity: 1; }
  
  .timer-header { width: 100%; display: flex; justify-content: space-between; position: absolute; top: 40px; padding: 0 20px; }
  .timer-header span { color: var(--muted); font-size: 0.9rem; }
  .close-timer { font-size: 1.5rem; color: var(--accent); cursor: pointer; }

  /* å·¨å‹æ•¸å­— */
  #tVal { 
    font-size: 18vw; font-family: 'Roboto Mono', monospace; font-weight: bold;
    color: #fff; text-shadow: 0 0 30px var(--accent); margin: 20px 0;
  }
  
  .timer-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 400px; }
  .timer-controls button { padding: 25px; font-size: 1.2rem; clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px); }

  .laps-container { 
    max-height: 25vh; overflow-y: auto; width: 100%; max-width: 400px; 
    margin-top: 30px; border-top: 1px dashed #333; padding-top: 10px; 
  }
  .lap-row { 
    display: flex; justify-content: space-between; color: #888; font-size: 1.2rem; 
    padding: 8px 0; border-bottom: 1px solid #222; font-family: 'Roboto Mono';
  }
  .lap-row span:first-child { color: var(--sec); }

  #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--accent); color: #000; padding: 15px 30px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.2s; z-index: 1000; clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px); font-size: 1.2rem; box-shadow: 0 0 50px rgba(0,255,195,0.5); }
  #toast.show { opacity: 1; }
  #copyArea { position: fixed; top: -9999px; left: -9999px; opacity: 0; }
</style>
</head>
<body>

<div id="toast">âœ… å·²å­˜æª”</div>

<div id="timerBtn" onclick="toggleTimer()">00</div>

<div id="timerPanel">
  <div class="timer-header">
    <span>REST TIMER ///</span>
    <span class="close-timer" onclick="toggleTimer()">[ ç¸®å° ]</span>
  </div>

  <div id="tVal">00:00.00</div>
  
  <div class="timer-controls">
    <button class="ghost" id="tAction" onclick="timerAct()">é–‹å§‹è¨ˆæ™‚</button>
    <button class="warn" onclick="timerLapReset()" id="tLapReset">è¨ˆåœˆ</button>
  </div>

  <div class="laps-container" id="lapsList"></div>
</div>

<div class="shell">
  <h1>ZIP LOG <span style="font-size:0.8rem; color:var(--accent);">/// SYSTEM V12</span></h1>

  <section>
    <h2 style="margin-bottom:1rem;">SESSION_TIME <small>æ™‚é–“</small></h2>
    <div class="row">
      <div><label>é‡è¨“é–‹å§‹</label><div class="time-field"><input type="time" id="wtStart"><button class="ghost sm" onclick="setNow('wtStart')">ç¾åœ¨</button></div></div>
      <div><label>é‡è¨“çµæŸ</label><div class="time-field"><input type="time" id="wtEnd"><button class="ghost sm" onclick="setNow('wtEnd')">ç¾åœ¨</button></div></div>
    </div>
    <div style="text-align:right; color:var(--muted); font-size:0.7rem;" id="wtDur">æŒçºŒæ™‚é–“: 0 åˆ†é˜</div>
  </section>

  <section>
    <h2>RESISTANCE <small>é‡è¨“</small></h2>
    <div id="exerciseList"></div>
    <button class="add-btn" onclick="addExercise()">[+] æ–°å¢å‹•ä½œ</button>
  </section>

  <section>
    <h2>CARDIO <small>æœ‰æ°§</small></h2>
    <div class="row" style="margin-bottom:15px; border-bottom:1px dashed #333; padding-bottom:15px;">
       <div><label>æœ‰æ°§é–‹å§‹</label><div class="time-field"><input type="time" id="caStart"><button class="ghost sm" onclick="setNow('caStart')">ç¾åœ¨</button></div></div>
       <div><label>æœ‰æ°§çµæŸ</label><div class="time-field"><input type="time" id="caEnd"><button class="ghost sm" onclick="setNow('caEnd')">ç¾åœ¨</button></div></div>
    </div>
    <div id="cardioList"></div>
    <button class="add-btn" onclick="addCardio()">[+] æ–°å¢æœ‰æ°§</button>
    <div style="margin-top:15px;"><label>ä¼¸å±•æ™‚é–“ (åˆ†é˜)</label><input type="number" id="stretch" placeholder="ä¾‹å¦‚: 15"></div>
  </section>

  <section>
    <h2>NUTRITION <small>é£²é£Ÿ</small></h2>
    
    <label class="sub-label">BREAKFAST æ—©é¤</label>
    <div id="listBreakfast"></div>
    <button class="add-btn sm" onclick="addFood('listBreakfast', 'breakfast-options')">[+] æ–°å¢</button>

    <label class="sub-label">LUNCH åˆé¤</label>
    <div id="listLunch"></div>
    <button class="add-btn sm" onclick="addFood('listLunch', 'lunch-options')">[+] æ–°å¢</button>

    <label class="sub-label">SNACK ä¸‹åˆèŒ¶</label>
    <div id="listSnack"></div>
    <button class="add-btn sm" onclick="addFood('listSnack', 'snack-options')">[+] æ–°å¢</button>

    <label class="sub-label">PRE-WORKOUT é‹å‹•å‰</label>
    <div id="listPre"></div>
    <button class="add-btn sm" onclick="addFood('listPre', 'pre-options')">[+] æ–°å¢</button>

    <label class="sub-label">POST / DINNER æ™šé¤/å¾Œ</label>
    <div id="listPost"></div>
    <button class="add-btn sm" onclick="addFood('listPost', 'post-options')">[+] æ–°å¢</button>

    <div style="margin-top:20px; border-top:1px solid #333; padding-top:10px;">
        <label class="sub-label">HYDRATION é£²æ°´ (ML)</label>
        <div class="row">
            <input type="number" id="wWork" placeholder="é‹å‹•é£²æ°´" oninput="calcWater()">
            <input type="number" id="wDay" placeholder="æ—¥å¸¸é£²æ°´" oninput="calcWater()">
        </div>
        <div style="text-align:right; color:var(--sec); font-size:0.9rem;" id="wTotal">ç¸½è¨ˆ: 0 ML</div>
    </div>
  </section>

  <section>
    <h2>NOTES <small>å‚™è¨»</small></h2>
    <textarea id="note" placeholder="ç´€éŒ„ä»Šæ—¥èº«é«”ç‹€æ³..."></textarea>
  </section>

</div>

<div class="float-action">
  <button class="icon-only" onclick="forceReset()">ğŸ—‘ï¸</button>
  <button class="ghost" onclick="genText()">ğŸ“‹ è¤‡è£½æ—¥èªŒ</button>
  <button class="main" onclick="manualSave()">ğŸ’¾ æ‰‹å‹•å­˜æª”</button>
</div>
<textarea id="copyArea"></textarea>

<template id="equipment-options">
    <option value="">â€” é¸æ“‡å™¨æ â€”</option>
    <optgroup label="èƒŒéƒ¨èˆ‡ä¸ŠåŠèº«">
      <option>åˆ†é›¢å¼åå§¿åˆ’èˆ¹æ©Ÿ</option><option>åå§¿åˆ’èˆ¹æ©Ÿ</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆå¯¬è·ï¼‰</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆçª„è·ï¼‰</option>
      <option>é«˜ä½ä¸‹æ‹‰ï¼ˆçª„è·åæ¡ï¼‰</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆWæŠŠæ‰‹ï¼‰</option><option>é«˜ä½ä¸‹æ‹‰ï¼ˆVæŠŠæ‰‹ï¼‰</option>
      <option>è´è¶æ©Ÿï¼ˆæ­£é¢èƒ¸æ¨ï¼‰</option><option>è´è¶æ©Ÿï¼ˆåé¢èƒŒé£›ï¼‰</option>
    </optgroup>
    <optgroup label="ä¸‹åŠèº«">
      <option>è…¿éƒ¨æ¨è¹¬æ©Ÿ</option><option>åå§¿å‹¾è…¿æ©Ÿ</option><option>ä¿¯è‡¥å‹¾è…¿æ©Ÿ</option>
      <option>å¤¾è…¿æ©Ÿ</option><option>é–‹è…¿æ©Ÿ</option><option>ä¸‹èƒŒè¨“ç·´æ©Ÿ</option>
    </optgroup>
    <optgroup label="æ ¸å¿ƒ"><option>å·è…¹æ©Ÿ</option></optgroup>
    <option value="__custom__">è‡ªè¨‚...</option>
</template>
<template id="cardio-options">
    <option value="">â€” é¸æ“‡é …ç›® â€”</option>
    <option>æ»‘æ­¥æ©Ÿ</option><option>éšæ¢¯æ©Ÿ</option><option>è¸æ­¥æ©Ÿ</option><option>èººå¼è…³è¸è»Š</option><option>ç›´ç«‹è…³è¸è»Š</option><option>è·‘æ­¥æ©Ÿ</option>
    <option value="__custom__">è‡ªè¨‚...</option>
</template>
<template id="breakfast-options">
    <option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option>
    <option>ç¾å¼å’–å•¡</option><option>è¥¿è¥¿é‡Œå’–å•¡</option><option>ç„¡ç³–ç¶ èŒ¶</option><option>æ°£æ³¡æ°´</option>
    <option>çƒ¤åœŸå¸</option><option>å…¨å®¶ è‘¡è„åå¸2ç‰‡</option><option>è·åŒ…è›‹ 1é¡†</option><option>è·åŒ…è›‹ 2é¡†</option>
    <option>æ—é³³ç‡Ÿå¸Œè‡˜å¼å„ªæ ¼(åŸå‘³ç„¡ç³–)</option><option>çƒ¤åœ°ç“œ(å†°)</option><option>çƒ¤åœ°ç“œ(ç†±)</option>
    <option>è˜¿è””ç³•</option><option>å‰ç‡’åŒ…</option><option>è‚‰æ¡‚æ²</option><option value="__custom__">è‡ªè¨‚...</option>
</template>
<template id="lunch-options">
    <option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option>
    <option>èƒ½é‡å°å§-æ°´ç…®å«©é›èƒ¸</option><option>èƒ½é‡å°å§-é¦™æ»·é›è…¿</option><option>èƒ½é‡å°å§-æ—¥å¼å£½å–œç‰›ä¾¿ç•¶</option>
    <option>èƒ½é‡å°å§-ç…§ç‡’é›è…¿æ’</option><option>ç«¹æ—ä¾¿ç•¶-é¦™é…¥å¤§é›æ’é£¯</option><option>ç«¹æ—ä¾¿ç•¶-åšåˆ‡è±¬æ’é£¯</option>
    <option>å¤©å¤©çƒ¤è‚‰-æ‹›ç‰Œçƒ¤è‚‰é£¯</option><option>ç‰›æ’</option><option>èŠ±æ¤°èœ</option><option>å››å­£è±†</option>
    <option>é«˜éº—èœ</option><option>é¦¬éˆ´è–¯</option><option>ç™½é£¯</option><option>ç³™ç±³é£¯</option><option>é†‹é£¯</option>
    <option>ç‚’é£¯</option>
    <option>æ„›é¢ç…®ï¼ˆç´…ç‡’ç‰›è‚‰é¢¨å‘³ï¼‰</option><option>æ°£ç‚¸é›èƒ¸è‚‰</option><option>é†¬ç‡’é›èƒ¸è‚‰</option>
    <option>ä¸‰æ¯é›</option><option>æ——é­šç”Ÿé­šç‰‡</option><option>é®ªé­šç”Ÿé­šç‰‡</option><option>é®­é­šç”Ÿé­šç‰‡</option><option>é¯¡é­šåµç”Ÿé­šç‰‡</option>
    <option value="__custom__">è‡ªè¨‚...</option>
</template>
<template id="snack-options">
    <option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option>
    <option>ç¾å¼å’–å•¡</option><option>ç„¡ç³–ç¶ èŒ¶</option><option>æ°£æ³¡æ°´</option>
    <option>ç¦æ¨‚ è¶…èƒ½è›‹ç™½ç‡Ÿé¤Šç‰›ä¹³å¯å¯å£å‘³ (375 mL)</option><option>æ°´æœï¼ˆèŠ­æ¨‚ï¼‰</option><option>é¤…ä¹¾ï¼å°é»å¿ƒ</option>
    <option>åŸå‘³å„ªæ ¼</option><option>æ—é³³ç‡Ÿ å¸Œè‡˜å¼å„ªæ ¼(åŸå‘³ç„¡ç³–)</option><option>èŠ­æ¨‚</option><option>è˜‹æœ</option>
    <option>èŠ’æœ</option><option>æ°´æ¢¨</option><option>æŸ³ä¸</option><option>æ©˜å­</option><option>å»æ®¼æ¤°å­</option>
    <option>è—è“</option><option>ä¹³æ¸…è›‹ç™½ 40g</option><option>ä¹³æ¸…è›‹ç™½ 30g</option><option value="__custom__">è‡ªè¨‚...</option>
</template>
<template id="pre-options">
    <option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option>
    <option>ç¾å¼å’–å•¡</option><option>è¥¿è¥¿é‡Œå’–å•¡</option><option>æ‰‹æ²–å’–å•¡</option><option>ç„¡ç³–ç¶ èŒ¶</option>
    <option>æ°£æ³¡æ°´</option><option>å…‰æ³‰ å„ªè³ªè›‹ç™½ç‰›ä¹³ å·§å…‹åŠ›å£å‘³ (400ml)</option>
    <option>ç¦æ¨‚ è¶…èƒ½è›‹ç™½ç‡Ÿé¤Šç‰›ä¹³ å¯å¯å£å‘³ (375 mL)</option><option>ç¦æ¨‚ è¶…èƒ½è›‹ç™½ç‡Ÿé¤Šç‰›ä¹³ å’–å•¡å£å‘³ (375 mL)</option>
    <option>çƒ¤åœ°ç“œ (å†°)</option><option>çƒ¤åœ°ç“œ (ç†±)</option><option>å…¨å®¶ è‘¡è„åå¸2ç‰‡</option>
    <option>å…¨å®¶ å¤§äº¨å ¡ (åŸå‘³ç†±ç‹—+ç•ªèŒ„é†¬é…¸é»ƒç“œé†¬)</option><option>é¦™è•‰</option><option>èŠ­æ¨‚</option><option>è˜‹æœ</option>
    <option>èŠ’æœ</option><option>æ°´æ¢¨</option><option>æŸ³ä¸</option><option>æ©˜å­</option><option>å»æ®¼æ¤°å­</option>
    <option>è—è“</option><option>ä¹³æ¸…è›‹ç™½ 40g</option><option>ä¹³æ¸…è›‹ç™½ 30g</option><option value="__custom__">è‡ªè¨‚...</option>
</template>
<template id="post-options">
    <option value="">â€” é¸æ“‡é£Ÿç‰© â€”</option>
    <option>ç‰›é›œæ¹¯ï¼ˆåªåƒæ–™ï¼‰</option><option>ç‰›æ’</option><option>èŠ±æ¤°èœ</option><option>å››å­£è±†</option><option>é«˜éº—èœ</option>
    <option>é¦¬éˆ´è–¯</option><option>ç™½é£¯</option><option>ç³™ç±³é£¯</option><option>é†‹é£¯</option><option>æ°£ç‚¸é›èƒ¸è‚‰</option>
    <option>æ——é­šç”Ÿé­šç‰‡</option><option>é®ªé­šç”Ÿé­šç‰‡</option><option>é®­é­šç”Ÿé­šç‰‡</option><option>é¯¡é­šåµç”Ÿé­šç‰‡</option>
    <option>æ„›ä¹‹å‘³é®ªé­šç½é ­ï¼ˆæ°´ç…®ï¼‰185g</option><option>è·åŒ…è›‹</option><option>æ»·è›‹</option><option>æºå¿ƒè›‹</option>
    <option>è±†è–¯æ¶¼æ‹Œ</option><option>åŸå‘³å„ªæ ¼</option><option>èŠ­æ¨‚</option><option>è˜‹æœ</option><option>èŠ’æœ</option><option>æ°´æ¢¨</option>
    <option>æŸ³ä¸</option><option>æ©˜å­</option><option>å»æ®¼æ¤°å­</option><option>è—è“</option>
    <option>ä¹³æ¸…è›‹ç™½ 40g</option><option>ä¹³æ¸…è›‹ç™½ 30g</option><option value="__custom__">è‡ªè¨‚...</option>
</template>

<script>
const KEY = 'ZIP_LOG_V12_DATA';
let tInt=null, tStart=0, tElapsed=0, laps=[];

function checkUnit(v, u) {
  const m = { 'ml':['å’–','èŒ¶','é£²','æ°´','æ¹¯','å¥¶','é…’','æ¨‚','ä¹³'], 'é¡†':['è›‹','æœ','æ©˜','æŸ³','å¥‡','é¤ƒ','éŒ ','æ¤°'], 'g':['é›','ç‰›','è±¬','é­š','è‚‰','é£¯','ç“œ','è–¯','èœ','æ ¼','è›‹ç™½'], 'ç‰‡':['å','é¤…','èµ·','ç³•','æ’'], 'ä»½':['ä¾¿','é¤','å ¡','æ²»','éºµ'] };
  for(const [k, arr] of Object.entries(m)) if(arr.some(x => v.includes(x))) { u.value = k; break; }
}

function createRow(tid, ph, vals={}) {
  const div = document.createElement('div');
  div.className = tid.includes('option') && !tid.includes('equip') && !tid.includes('cardio') ? 'food-row' : 'item-row';
  const sel = document.createElement('select'); sel.innerHTML = document.getElementById(tid).innerHTML;
  const cust = document.createElement('input'); cust.type = 'text'; cust.className = 'custom-input'; cust.placeholder = ph;
  const del = document.createElement('button'); del.innerHTML = '&times;'; del.className = 'del-btn'; del.onclick = () => div.remove();
  
  const chk = (v) => { if(div.querySelector('.unit')) checkUnit(v, div.querySelector('.unit')); };
  sel.onchange = () => { if(sel.value==='__custom__'){cust.classList.add('show');cust.focus();}else{cust.classList.remove('show');chk(sel.value);} };
  cust.oninput = () => chk(cust.value);

  if (vals.n) {
    if([...sel.options].some(o=>o.value===vals.n)) sel.value = vals.n;
    else { sel.value='__custom__'; cust.classList.add('show'); cust.value=vals.n; }
  }
  div.append(del, sel, cust); return { div, sel, cust };
}

function addExercise(d={}) {
  const {div} = createRow('equipment-options', 'å™¨æåç¨±', d);
  const c = document.createElement('div'); c.className='item-controls';
  c.innerHTML = `<input type="number" class="s" placeholder="çµ„æ•¸" value="${d.s||''}"><input type="number" class="r" placeholder="æ¬¡æ•¸" value="${d.r||''}"><input type="number" class="w" placeholder="é‡é‡kg" value="${d.w||''}"><input type="number" class="rt" placeholder="ä¼‘æ¯ç§’" value="${d.rt||''}">`;
  div.appendChild(c); document.getElementById('exerciseList').appendChild(div);
}
function addCardio(d={}) {
  const {div} = createRow('cardio-options', 'æœ‰æ°§é …ç›®', d);
  const c = document.createElement('div'); c.className='item-controls'; c.style.gridTemplateColumns="1fr 1fr 1fr";
  c.innerHTML = `<input type="number" class="dur" placeholder="åˆ†é˜" value="${d.dur||''}"><input type="number" class="lv" placeholder="ç­‰ç´š" value="${d.lv||''}"><input type="number" class="bpm" placeholder="å¿ƒç‡" value="${d.bpm||''}">`;
  div.appendChild(c); document.getElementById('cardioList').appendChild(div);
}
function addFood(lid, tid, d={}) {
  const {div} = createRow(tid, 'é£Ÿç‰©åç¨±', d);
  const c = document.createElement('div'); c.className='food-inputs';
  c.innerHTML = `<input type="number" class="amt" placeholder="æ•¸é‡" value="${d.a||''}"><select class="unit"><option value="g">g</option><option value="ml">ml</option><option value="ä»½">ä»½</option><option value="é¡†">é¡†</option><option value="ç‰‡">ç‰‡</option></select>`;
  if(d.u) c.querySelector('.unit').value = d.u;
  div.appendChild(c); document.getElementById(lid).appendChild(div);
}

function getName(r) { const s=r.querySelector('select'), c=r.querySelector('.custom-input'); return s.value==='__custom__'?c.value:s.value; }
function v(p,s) { return p.querySelector(s)?.value||''; }

function save(silent=true) {
  const d = {
    wtStart:val('#wtStart'), wtEnd:val('#wtEnd'), caStart:val('#caStart'), caEnd:val('#caEnd'), stretch:val('#stretch'), wWork:val('#wWork'), wDay:val('#wDay'), note:val('#note'),
    exs: getAll('#exerciseList .item-row').map(r=>({ n:getName(r), s:v(r,'.s'), r:v(r,'.r'), w:v(r,'.w'), rt:v(r,'.rt') })),
    cardios: getAll('#cardioList .item-row').map(r=>({ n:getName(r), dur:v(r,'.dur'), lv:v(r,'.lv'), bpm:v(r,'.bpm') })),
    foods: { bf:getF('listBreakfast'), lu:getF('listLunch'), sn:getF('listSnack'), pre:getF('listPre'), post:getF('listPost') },
    timer: { start: tStart, elapsed: tElapsed, running: !!tInt, laps: laps }
  };
  localStorage.setItem(KEY, JSON.stringify(d));
  if(!silent){ const t=document.getElementById('toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1000); }
}
function getF(id) { return getAll(`#${id} .food-row`).map(r=>({ n:getName(r), a:v(r,'.amt'), u:v(r,'.unit') })); }

function load() {
  const raw = localStorage.getItem(KEY); if(!raw){ addExercise(); return; }
  const d = JSON.parse(raw);
  set('#wtStart',d.wtStart); set('#wtEnd',d.wtEnd); set('#caStart',d.caStart); set('#caEnd',d.caEnd); 
  set('#stretch',d.stretch); set('#wWork',d.wWork); set('#wDay',d.wDay); set('#note',d.note);
  
  document.getElementById('exerciseList').innerHTML=''; if(d.exs) d.exs.forEach(x=>addExercise(x));
  document.getElementById('cardioList').innerHTML=''; if(d.cardios) d.cardios.forEach(x=>addCardio(x));
  
  const rf = (lid,tid,lst) => { document.getElementById(lid).innerHTML=''; if(lst) lst.forEach(x=>addFood(lid,tid,x)); };
  if(d.foods) { rf('listBreakfast','breakfast-options',d.foods.bf); rf('listLunch','lunch-options',d.foods.lu); rf('listSnack','snack-options',d.foods.sn); rf('listPre','pre-options',d.foods.pre); rf('listPost','post-options',d.foods.post); }
  
  if(d.timer) { tElapsed=d.timer.elapsed||0; laps=d.timer.laps||[]; renderLaps(); updT(tElapsed); if(d.timer.running){ tStart=d.timer.start; startT(); } }
  calcTime(); calcWater();
}

// === Timer Logic (Fullscreen) ===
function fmtT(ms) { return `${pad(Math.floor(ms/60000))}:${pad(Math.floor((ms%60000)/1000))}.${pad(Math.floor((ms%1000)/10))}`; }
function updT(ms) { 
  document.getElementById('tVal').innerText=fmtT(ms); 
  // HUD Button update
  document.getElementById('timerBtn').innerText=String(Math.floor((ms%60000)/1000)).padStart(2,'0'); 
}
function startT() {
  document.getElementById('tAction').innerText="æš«åœ"; document.getElementById('tAction').className="warn"; document.getElementById('tLapReset').innerText="è¨ˆåœˆ";
  tInt = setInterval(() => updT(tElapsed + (Date.now() - tStart)), 50);
}
function timerAct() {
  if(tInt) { clearInterval(tInt); tInt=null; tElapsed+=Date.now()-tStart; document.getElementById('tAction').innerText="ç¹¼çºŒ"; document.getElementById('tAction').className="ghost"; document.getElementById('tLapReset').innerText="é‡ç½®"; save(true); }
  else { tStart=Date.now(); startT(); }
}
function timerLapReset() {
  if(tInt) { laps.unshift(tElapsed+(Date.now()-tStart)); renderLaps(); }
  else { tElapsed=0; laps=[]; updT(0); document.getElementById('lapsList').innerHTML=''; document.getElementById('tAction').innerText="é–‹å§‹è¨ˆæ™‚"; document.getElementById('tLapReset').innerText="è¨ˆåœˆ"; save(true); }
}
function renderLaps() { document.getElementById('lapsList').innerHTML = laps.map((t,i)=>`<div class="lap-row"><span>åœˆ ${laps.length-i}</span><span>${fmtT(t)}</span></div>`).join(''); }
function toggleTimer() { document.getElementById('timerPanel').classList.toggle('show'); }

// === Reset ===
function forceReset() {
  if(confirm('âš ï¸ ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Œé–‹å§‹æ–°çš„ä¸€å¤©å—ï¼Ÿ\n(ç›®å‰çš„ç´€éŒ„å°‡è¢«æ¸…é™¤ï¼Œè«‹ç¢ºèªå·²è¤‡è£½)')) {
    localStorage.removeItem(KEY);
    document.querySelectorAll('input').forEach(i => i.value = '');
    document.querySelectorAll('textarea').forEach(t => t.value = '');
    document.querySelectorAll('.item-row, .food-row').forEach(r => r.remove());
    document.getElementById('wTotal').innerText = 'ç¸½è¨ˆ: 0 ML';
    document.getElementById('wtDur').innerText = 'æŒçºŒæ™‚é–“: 0 åˆ†é˜';
    location.reload();
  }
}

async function genText() {
  save(true); const d=JSON.parse(localStorage.getItem(KEY)); const dt=new Date();
  let t=`ğŸ“… ${dt.getFullYear()}/${dt.getMonth()+1}/${dt.getDate()} è¨“ç·´æ—¥èªŒ\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ° è¨“ç·´æ™‚é–“\nâ€¢ ${d.wtStart} - ${d.wtEnd} (å…± ${document.getElementById('wtDur').innerText.replace('æŒçºŒæ™‚é–“: ','')})\n`;
  if(d.exs.some(x=>x.n)) { t+=`\nğŸ‹ï¸ é‡è¨“é …ç›®\n`; d.exs.forEach(x=>{if(x.n)t+=`â€¢ ${x.n}ï½œ${x.s}çµ„Ã—${x.r}æ¬¡ï½œ${x.w}kg${x.rt?` (ä¼‘${x.rt}s)`:''}\n`}); }
  if(d.cardios.some(x=>x.n)||val('#caStart')) { t+=`\nğŸƒ æœ‰æ°§èˆ‡ä¼¸å±•\n`; if(val('#caStart'))t+=`â€¢ æ™‚é–“: ${val('#caStart')} - ${val('#caEnd')}\n`; d.cardios.forEach(x=>{if(x.n)t+=`â€¢ ${x.n}ï½œ${x.dur}åˆ† (Lv.${x.lv}/${x.bpm}bpm)\n`}); if(val('#stretch'))t+=`â€¢ ä¼¸å±•: ${val('#stretch')} åˆ†é˜\n`; }
  t+=`\nğŸ¥— é£²é£Ÿç´€éŒ„\n`;
  const ft=(l,h)=>{ if(l.some(x=>x.n)){ t+=`[${h}] `; t+=l.filter(x=>x.n).map(x=>`${x.n} ${x.a}${x.u}`).join('ã€')+'\n'; } };
  ft(d.foods.bf,'æ—©é¤'); ft(d.foods.lu,'åˆé¤'); ft(d.foods.sn,'åˆèŒ¶'); ft(d.foods.pre,'é‹å‰'); ft(d.foods.post,'é‹å¾Œ');
  t+=`\nğŸ’§ é£²æ°´ç¸½è¨ˆ: ${document.getElementById('wTotal').innerText.replace('ç¸½è¨ˆ: ','')}`;
  if(d.note) t+=`\n\nğŸ“ å‚™è¨»\n${d.note}`;
  try { await navigator.clipboard.writeText(t); alert('æ—¥èªŒå·²è¤‡è£½ï¼'); }
  catch(e) { const a=document.getElementById('copyArea'); a.value=t; a.select(); document.execCommand('copy'); alert('æ—¥èªŒå·²è¤‡è£½ (å…¼å®¹æ¨¡å¼)'); }
}

function manualSave() { save(false); }
setInterval(()=>save(true), 900000);
window.addEventListener('visibilitychange', ()=>{if(document.hidden)save(true)});
function setNow(id) { const n=new Date(); document.getElementById(id).value=`${pad(n.getHours())}:${pad(n.getMinutes())}`; calcTime(); }
function calcTime() { const d=(s,e)=>{if(!s||!e)return 0; const [h1,m1]=s.split(':').map(Number); const [h2,m2]=e.split(':').map(Number); return Math.max(0,(h2*60+m2)-(h1*60+m1));}; document.getElementById('wtDur').innerText=`æŒçºŒæ™‚é–“: ${d(val('#wtStart'),val('#wtEnd'))} åˆ†é˜`; }
function calcWater() { document.getElementById('wTotal').innerText=`ç¸½è¨ˆ: ${(Number(val('#wWork'))||0)+(Number(val('#wDay'))||0)} ML`; }
const val=s=>document.querySelector(s)?.value||''; const set=(s,v)=>{const e=document.querySelector(s);if(e)e.value=v||''}; const getAll=s=>[...document.querySelectorAll(s)]; const pad=n=>String(n).padStart(2,'0');
load();
</script>
</body>
</html>
